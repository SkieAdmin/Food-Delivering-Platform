<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %> | GoCotano</title>
  <link rel="stylesheet" href="/css/style.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body>
  <%- include('../partials/header') %>

  <div class="container" style="max-width: 900px;">
    <h1 style="color: var(--primary-blue); margin-bottom: 2rem;">
      Order #<%= order.orderNumber %>
    </h1>

    <div class="grid grid-2" style="gap: 2rem;">
      <!-- Order Details -->
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">Order Details</h2>
        </div>
        <div class="card-body">
          <div style="margin-bottom: 1rem;">
            <strong style="color: var(--primary-blue);">Restaurant:</strong><br>
            <%= order.restaurant.name %>
          </div>

          <div style="margin-bottom: 1rem;">
            <strong style="color: var(--primary-blue);">Delivery Address:</strong><br>
            <%= order.deliveryAddress %>
          </div>

          <div style="margin-bottom: 1rem;">
            <strong style="color: var(--primary-blue);">Status:</strong><br>
            <span class="badge badge-<%= order.status === 'DELIVERED' ? 'success' : 'primary' %>" style="margin-top: 0.5rem;">
              <%= order.status.replace(/_/g, ' ') %>
            </span>
          </div>

          <div style="margin-bottom: 1rem;">
            <strong style="color: var(--primary-blue);">Order Date:</strong><br>
            <%= new Date(order.createdAt).toLocaleString() %>
          </div>
        </div>
      </div>

      <!-- Items Ordered -->
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">Items Ordered</h2>
        </div>
        <div class="card-body">
          <% order.orderItems.forEach(item => { %>
            <div class="d-flex justify-between" style="margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid var(--primary-blue-lighter);">
              <div>
                <strong><%= item.menuItem.name %></strong><br>
                <span style="color: var(--gray); font-size: 0.9rem;">Qty: <%= item.quantity %></span>
              </div>
              <div style="text-align: right;">
                <strong style="color: var(--primary-orange);">â‚±<%= (item.price * item.quantity).toFixed(2) %></strong>
              </div>
            </div>
          <% }); %>

          <div style="border-top: 2px solid var(--primary-blue); padding-top: 1rem; margin-top: 1rem;">
            <div class="d-flex justify-between" style="font-size: 1.25rem; font-weight: 700; color: var(--primary-orange);">
              <span>Total:</span>
              <span>â‚±<%= order.totalAmount.toFixed(2) %></span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Tracking Map -->
    <% if (order.status === 'OUT_FOR_DELIVERY' && order.tracking) { %>
      <div class="card" style="margin-top: 2rem;">
        <div class="card-header">
          <h2 class="card-title">ðŸš— Live Tracking</h2>
        </div>
        <div class="card-body">
          <div id="tracking-map" class="map-container"></div>
          <p style="text-align: center; color: var(--gray); margin-top: 1rem;">
            Your delivery is on the way!
            <% if (order.tracking.estimatedTime) { %>
              Estimated time: <%= order.tracking.estimatedTime %> minutes
            <% } %>
          </p>
        </div>
      </div>

      <script src="/socket.io/socket.io.js"></script>
      <script>
        const socket = io();
        let map, driverMarker, destinationMarker;

        function initMap() {
          const destination = [<%= order.deliveryLat %>, <%= order.deliveryLng %>];

          map = L.map('tracking-map').setView(destination, 14);

          // Use tile URL from environment/config
          const tileUrl = '<%= config.openStreetMap.tileUrl %>';
          L.tileLayer(tileUrl, {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            maxZoom: 19
          }).addTo(map);

          const destinationIcon = L.divIcon({
            className: 'custom-marker',
            html: '<div style="background-color: #4FC3F7; border: 3px solid #0288D1; width: 20px; height: 20px; border-radius: 50%;"></div>',
            iconSize: [20, 20],
            iconAnchor: [10, 10]
          });

          destinationMarker = L.marker(destination, {
            icon: destinationIcon,
            title: 'Delivery Location'
          }).addTo(map);

          <% if (order.tracking.driverLat && order.tracking.driverLng) { %>
            const driverPos = [<%= order.tracking.driverLat %>, <%= order.tracking.driverLng %>];

            const driverIcon = L.divIcon({
              className: 'custom-marker',
              html: '<div style="background-color: #FF9800; border: 3px solid #F57C00; width: 20px; height: 20px; border-radius: 50%;"></div>',
              iconSize: [20, 20],
              iconAnchor: [10, 10]
            });

            driverMarker = L.marker(driverPos, {
              icon: driverIcon,
              title: 'Driver'
            }).addTo(map);

            // Fit bounds to show both markers
            const bounds = L.latLngBounds([driverPos, destination]);
            map.fitBounds(bounds, { padding: [50, 50] });
          <% } %>
        }

        socket.emit('tracking:join', <%= order.id %>);

        socket.on('tracking:update', (data) => {
          const driverIcon = L.divIcon({
            className: 'custom-marker',
            html: '<div style="background-color: #FF9800; border: 3px solid #F57C00; width: 20px; height: 20px; border-radius: 50%;"></div>',
            iconSize: [20, 20],
            iconAnchor: [10, 10]
          });

          if (driverMarker) {
            driverMarker.setLatLng([data.lat, data.lng]);
          } else {
            driverMarker = L.marker([data.lat, data.lng], {
              icon: driverIcon,
              title: 'Driver'
            }).addTo(map);
          }
        });

        initMap();
      </script>
    <% } %>

    <div style="margin-top: 2rem; text-align: center;">
      <a href="/orders" class="btn btn-secondary">Back to Orders</a>
    </div>
  </div>

  <%- include('../partials/footer') %>
</body>
</html>
